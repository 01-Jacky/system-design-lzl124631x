# Design a News Feed System

All the social media sites have some sort of news feed system, like those in Facebook, Twitter, Instagram, Quora, and Medium.

News feed is a list of posts with text, image, or video generated by other entities in the system tailored for you to read. It's constantly updating while other entities creating new posts.

## Requirement

### Functional requirement

1. News feed is generated using the posts from other entities in the system that the user followed or the user might be interested in.
2. Posts might have text, image and video.
3. The new posts generated by others should be appended to the news feed of the user.

### Non-functional requirement

1. **News feed generation**: should happen near-real-time. The latency seen by the end user should be just  1~2 seconds.
2. **Appending new post**: After a new post is sent to the system, it shouldn't take more than 5 seconds to be able to show up in a news feed request.

## Capacity Estimation

> During the fourth quarter of 2019, _Facebook_ reported almost 1.66 billion daily active users \(_DAU_\). Overall, daily active users accounted for 66 percent of monthly active users. With over 2.5 billion monthly active users, _Facebook_ is the most popular social network worldwide.  
> [https://www.statista.com/statistics/346167/facebook-global-dau/](https://www.statista.com/statistics/346167/facebook-global-dau/)

The world population is just 7.8 billion as of March 2020. It means that 21% of world population are Facebook DAU and 32% are MAU. That's incredible.

To simplify computation, let's assume the system we are building have 1 billion DAU.

Assume on average a user follows 500 users or entities on Facebook. An entity can be a group or a page.

### Traffic Estimates

Assume on average one user fetches news feed 10 times per day. So it's `1e10` requests per day and about `116K` QPS.

### Storage Estimates

Assume on average we keep 500 posts of each user's news feed in memory for fast fetch, and each post is 1KB in size. So 500 KB per user, 500 TB for all DAUs, and 5000 machines if each of them has 100GB memory.

## System APIs

```text
getNewsFeed(userId, options?)
```

userId \(GUID\): the id of the user who is fetching the news feed

The optional `options` parameter can contain the following fields:

afterPostId \(GUID\): fetch the news feed from after this post. If unspecified, fetch the newest posts.

count \(number\): the maximum number of posts returned for each request. If unspecified, some default maximum number is set by the backend.

excludeReplies \(boolean\): used to prevent the news feed from containing the replies.

The return values is a JSON containing a list of news feed items.

## Database Design

### Basic objects

1. User
2. Entity \(page, group, etc\)
3. Post
4. Media

### Relationships

1. Follower-Followee: A User can follow other Users or Entities.
2. PostWriter-Post: Users and Entities can generate Posts. For simplicity, assume only Users can generate Posts.
3. Post-Media: Each Post has some associated Medias.

## High-level Design

### Workflows

#### Feed generation

When Alice ask for her news feed, the system will:

1. Get followees: retrieve the IDs of all the users/entities that Alice follows
2. Aggregate posts: retrieve latest, most pupular and relevant posts for those IDs.
3. Rank posts: rank the posts based on relevance.
4. Cache: cache the feeds generated and return the top 20 posts to Alice
5. Waterfall flow: When Alices reaches the end of those first 20 posts, another request is sent to fetch the next 20 posts.

Assume Alice follows Bob, and Bod sends a new post. The system will need to update Alice's news feed:

1. Get followers: retrieve the IDs of Bob's followers
2. Add posts: Add the post Bob created to the news feed pool of those IDs.
3. Rank posts: 
4. Update Cache:
5. Notify followers: 

#### Feed publishing

### Components

1. Web servers: maintains connections with the users.
2. Application server: executes the workflows mentioned above.
3. Database and cache:
   1. User/Entity: relationtional database
   2. Post: ?
   3. Media \(image/video\): blob storge
   4. Metadata: relational database?
4. Dedicated services:
   1. Feed generation
   2. Feed notification

## Detailed Design

### Feed generation

### Feed publishing

## Feed Ranking

## Data Partitioning





